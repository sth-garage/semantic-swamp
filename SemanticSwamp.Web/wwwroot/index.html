<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Semantic Swamp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700;800&display=swap"
          rel="stylesheet">
    <style>
        :root {
            --gb-blue-800: #63B3ED;
            --gb-blue-700: #4591E2;
            --gb-purple-800: #8F5D9C;
            --gb-dark-purple: #362730;
            --gb-pink: #E164A7;
            --gb-bg: #fefae0;
            --gb-surface: rgba(255,255,255,.96);
            --gb-border: rgba(40,54,24,.18);
            --gb-text: #1c1f13;
            --gb-muted: #6b705c;
            --app-shell-gradient: linear-gradient(135deg,#63B3ED 0%,#4591E2 30%, #8F5D9C 70%,#E164A7 100%);
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: "Barlow",system-ui,-apple-system, Segoe UI,Roboto,Arial,sans-serif;
            color: #1c1f13;
            background: var(--app-shell-gradient);
            overflow: hidden;
        }

        .main-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center
        }

        .app-content {
            width: 90%;
            height: 95%;
            display: flex;
            padding: 24px 28px
        }

        .chat-pane {
            flex: 1 1 auto;
            background: #fff;
            border: 1px solid var(--gb-border);
            border-radius: 18px;
            box-shadow: 0 18px 50px rgba(54,39,48,.16);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden
        }

        .pane-header-bar {
            padding: 14px 18px;
            border-bottom: 1px solid var(--gb-border);
            background: linear-gradient(90deg,#4591E2 0%,#E164A7 .18);
        }

        .pane-title {
            display: flex;
            align-items: center;
            font-weight: 800;
            color: #63B3ED
        }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg,#63B3ED,#8F5D9C);
            overflow: hidden;
            border: 2.5px solid rgba(254,250,224,.95)
        }

        .chat-messages-area {
            flex: 1 1 auto;
            margin: 14px;
            padding: 16px 12px;
            background: #FEFEFE;
            border-radius: 14px;
            border: 1px solid var(--gb-border);
            overflow-y: auto
        }

        .chat-input-row {
            display: flex;
            gap: 12px;
            padding: 14px;
            background: #ECECEC;
            border-top: 1px solid var(--gb-border)
        }

        #sendMessage, #uploadBtn, #uploadFileBtn {
            background: linear-gradient(180deg,#E164A7,#8F5D9C);
            color: #fff;
            font-weight: 800;
            border-radius: 12px;
            padding: .62em 1.4em;
            border: 1px solid rgba(0,0,0,.05);
            box-shadow: 0 10px 22px rgba(225,100,167,.35)
        }

        #sendButton {
            background: linear-gradient(180deg,#E164A7,#8F5D9C);
            color: #fff;
            font-weight: 800;
            border-radius: 12px;
            padding: .62em 1.4em
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="app-content">
            <section class="chat-pane shadow" id="chatPane">
                <div class="pane-header-bar">
                    <div class="pane-title">
                        <span class="avatar">
                            <img src="Images/chat.png"
                                 alt="Semantigator avatar" onerror="this.style.display='none'">
                        </span>
                        <span>Chat with Semantigator</span>
                    </div>
                </div>

                <div class="chat-messages-area" id="chatArea" tabindex="0">
                    <div class="welcome-message">
                        <h1>
                            Welcome to
                            <span style="background:var(--app-shell-gradient);-webkit-background-clip:text;
          -webkit-text-fill-color:transparent;">Semantic Swamp</span>
                        </h1>
                    </div>
                </div>

                <div class="chat-input-row">
                    <input type="text" id="sendMessage" class="form-control"
                           placeholder="Chat with Semantigator..." disabled autocomplete="off" />
                    <button id="sendButton" class="btn" disabled>Send</button>
                    <button id="uploadBtn" class="btn ms-2" data-bs-toggle="modal"
                            data-bs-target="#uploadModal" disabled>
                        Upload
                    </button>
                    <!-- New button to view uploads -->
                    <button id="viewUploadsBtn" class="btn ms-2" data-bs-toggle="modal"
                            data-bs-target="#uploadsModal">
                        View Uploads
                    </button>
                </div>
            </section>
        </div>
    </div>

    <!-- Chat Detail Modal (unchanged) -->
    <div class="modal fade" id="chatDetailModal" tabindex="-1"
         aria-labelledby="chatDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"
                        id="chatDetailModalLabel">
                        Message Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="chatDetailModalBody"></div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload File Modal (top positioned) -->
    <div class="modal fade" id="uploadModal" tabindex="-1"
         aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <!-- removed .modal-dialog-centered -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">
                        Upload File
                    </h5>
                    <button type="button" class="btn-close"
                            data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <!-- File selection -->
                    <div class="mb-3">
                        <label class="form-label">File</label>
                        <button id="chooseFileBtn" class="btn btn-outline-primary me-2">
                            Choose
                            File
                        </button><span id="selectedFileName"></span>
                        <input type="file" id="uploadFileInput" style="display:none;">
                    </div>

                    <!-- Collections dropdown -->
                    <div class="mb-3">
                        <label for="collectionsDropdown"
                               class="form-label">Collections</label>
                        <div id="collectionSelectionWrapper" class="d-flex align-items-center">
                            <select class="form-select me-2" id="collectionsDropdown"></select>
                            <input type="text" class="form-control d-none me-2"
                                   id="newCollectionInput" placeholder="New Collection Name">
                            <button class="btn btn-outline-secondary toggle-btn"
                                    data-target="collection">
                                Add
                            </button>
                        </div>
                    </div>

                    <!-- Categories dropdown -->
                    <div class="mb-3">
                        <label for="categoriesDropdown"
                               class="form-label">Categories</label>
                        <div id="categorySelectionWrapper" class="d-flex align-items-center">
                            <select class="form-select me-2" id="categoriesDropdown"></select>
                            <input type="text" class="form-control d-none me-2"
                                   id="newCategoryInput" placeholder="New Category Name">
                            <button class="btn btn-outline-secondary toggle-btn"
                                    data-target="category">
                                Add
                            </button>
                        </div>
                    </div>

                    <!-- Terms multiselect -->
                    <div class="mb-3">
                        <label class="form-label">Terms</label>
                        <div id="termsContainer" style="max-height:150px;overflow-y:auto;">
                            <!-- checkboxes will be inserted here -->
                        </div>
                        <div class="d-flex align-items-center mt-2">
                            <input type="text" id="newTermInput"
                                   class="form-control me-2" placeholder="New term name">
                            <button id="addTermBtn" class="btn btn-outline-primary">
                                Add
                                Term
                            </button>
                        </div>
                        <div id="addedTermsContainer" class="mt-2"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                    <button id="uploadFileBtn" class="btn">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Uploads list modal -->
    <div class="modal fade" id="uploadsModal" tabindex="-1"
         aria-labelledby="uploadsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"
                        id="uploadsModalLabel">
                        Document Uploads
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-sm table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>CreatedOn</th>
                                <th>CollectionId</th>
                                <th>Collection</th>
                                <th>CategoryId</th>
                                <th>Category</th>
                                <th>IsActive</th>
                                <th>HasBeenProcessed</th>
                            </tr>
                        </thead>
                        <tbody id="uploadsTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary" data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
    </script>
    <script>
// ────────────────────────
// Utility helpers
// ────────────────────────
const api = {
  categories: '/api/Categories/Simple',
  collections: '/api/Collections/Simple',
  terms:      '/api/Terms/Simple',
  uploads:    '/api/DocumentUploads/Simple'
};

let cachedData = {categories: [], collections: [], terms: []}; // cache for reuse

// ────────────────────────
// Populate dropdowns / terms from API
// ────────────────────────
async function fetchAndCache(url, key) {
  try{
    const r=await fetch(url);
    if(!r.ok) throw new Error(r.statusText);
    const data=await r.json();
    cachedData[key]=data;
    return data;
  }catch(e){ console.warn('fetch error',url,e); return []; }
}

function populateSelect(id, array){
  const $sel=$(id);
  $sel.empty().append('<option value="0">-- none --</option>');
  array.forEach((item,i)=>{ // assume item has Id and Name
    const val=item.Id||i+1;
    $sel.append(`<option value="${val}">${item.Name||item}</option>`);
  });
}

function populateTerms(){
  $('#termsContainer').empty();
  cachedData.terms.forEach((t,i)=>{
    const id=t.Id||i+1;
    $('#termsContainer').append(
      `<div class="form-check"><input class="form-check-input" type="checkbox"
          value="${id}" id="term-${id}"><label class="form-check-label"
          for="term-${id}">${t.Name||t}</label></div>`
    );
  });
}

async function initDropdowns(){
  const [cats,cols,terms] = await Promise.all([
    fetchAndCache(api.categories,'categories'),
    fetchAndCache(api.collections,'collections'),
    fetchAndCache(api.terms,'terms')
  ]);
  populateSelect('#categoriesDropdown',cats);
  populateSelect('#collectionsDropdown',cols);
  populateTerms();
}

// ────────────────────────
// Modal helpers
// ────────────────────────
function toggleInput(selectId, inputId, btn){
  const $sel=$(selectId),$in=$(''+inputId);
  if($sel.is(':visible')){
    $sel.addClass('d-none');$in.removeClass('d-none').focus();btn.text('Back');
  }else{ $sel.removeClass('d-none');$in.addClass('d-none').val('');
         btn.text('Add');}
}

function resetUploadModal(){
  $('#uploadFileInput').val('');
  $('#selectedFileName').text('');
  $('#collectionsDropdown, #categoriesDropdown').val('0');
  $('#newCollectionInput, #newCategoryInput').addClass('d-none').val('');
  $('.toggle-btn[data-target="collection"]').text('Add');
  $('.toggle-btn[data-target="category"]').text('Add');
  $('#termsContainer input[type=checkbox]').prop('checked',false);
  $('#addedTermsContainer').empty();
}

// ────────────────────────
// Upload logic
// ────────────────────────
let newTermNames=[];
$('#addTermBtn').on('click',()=>{const n=$('#newTermInput').val().trim();if(!n)return;
  newTermNames.push(n);
  const $badge=$('<span>').addClass('badge bg-secondary me-1 mb-1')
      .text(n+' ');
  const $rm=$('<button type="button" class="btn-close btn-close-white ms-1 p-0"></button>');
  $rm.on('click',()=>{newTermNames=newTermNames.filter(t=>t!==n);$badge.remove();});
  $badge.append($rm);$('#addedTermsContainer').append($badge);
  $('#newTermInput').val('');
});

$('#chooseFileBtn').on('click',()=>$('#uploadFileInput').trigger('click'));
$('#uploadFileInput').on('change',()=>{
  const f=$('#uploadFileInput')[0].files[0];
  $('#selectedFileName').text(f?f.name:'');
});

$('#uploadFileBtn').on('click',async ()=>{
  const file=$('#uploadFileInput')[0].files[0];
  if(!file){alert('Please choose a file first.');return;}
  const formData=new FormData();formData.append('file',file);
  // ids
  const colId=parseInt($('#collectionsDropdown').val())||0;
  const catId=parseInt($('#categoriesDropdown').val())||0;
  if(colId)formData.append('collectionId',colId);
  if(catId)formData.append('categoryId',catId);
  // new names
  const nCol=$('#newCollectionInput').val().trim();
  const nCat=$('#newCategoryInput').val().trim();
  if(nCol)formData.append('newCollectionName',nCol);
  if(nCat)formData.append('newCategoryName',nCat);
  // terms
  const termIds=[];
  $('#termsContainer input[type=checkbox]:checked').each(function(){termIds.push($(this).val());});
  if(termIds.length) formData.append('termIds',JSON.stringify(termIds));
  if(newTermNames.length) formData.append('newTermNames',JSON.stringify(newTermNames));

  const $btn=$(this);$btn.prop('disabled',true);
  try{
    const r=await fetch('/api/file/upload',{method:'POST',body:formData});
    if(!r.ok) throw new Error(r.statusText);
    alert('Upload succeeded');
    $('#uploadModal').modal('hide');
    // refresh lists
    await initDropdowns();
    loadUploads();  // update uploads table too
  }catch(e){console.error(e);alert('Upload failed.');}
  finally{$btn.prop('disabled',false);}
});

$('#uploadModal').on('hidden.bs.modal',resetUploadModal);

// ────────────────────────
// Uploads table logic
// ────────────────────────
async function loadUploads(){
  try{
    const r=await fetch(api.uploads);
    if(!r.ok) throw new Error(r.statusText);
    const data=await r.json();
    const $tbody=$('#uploadsTableBody');$tbody.empty();
    data.forEach(u=>{
      const row=`<tr><td>${u.Name||''}</td>
        <td>${new Date(u.CreatedOn).toLocaleString()||''}</td>
        <td>${u.CollectionId||''}</td>
        <td>${(cachedData.collections.find(c=>c.Id==u.CollectionId)||{}).Name||''}</td>
        <td>${u.CategoryId||''}</td>
        <td>${(cachedData.categories.find(c=>c.Id==u.CategoryId)||{}).Name||''}</td>
        <td>${u.IsActive?'✓':'✗'}</td>
        <td>${u.HasBeenProcessed?'✓':'✗'}</td></tr>`;
      $tbody.append(row);
    });
  }catch(e){console.warn('load uploads error',e);}
}

// ────────────────────────
// Chat functionality (unchanged)
// ────────────────────────
$(function(){
  const $chatArea=$('#chatArea'),$sendMsg=$('#sendMessage'),
        $sendBtn=$('#sendButton'),$uploadBtn=$('#uploadBtn');

  // WebSocket setup omitted for brevity – same as original

  // Enable/disable controls
  function setEnabled(state=true){
    $sendMsg.prop('disabled',!state);
    $sendBtn.prop('disabled',!state||$sendMsg.val().trim()==='');
    $uploadBtn.prop('disabled',!state);}

  // Input handling – same as original
  // …

  // After a successful upload refresh lists & uploads table
  // (already done in upload handler)

  // Load initial data on page load
  initDropdowns();
  loadUploads();

  // Show uploads modal when button clicked
  $('#viewUploadsBtn').on('click',()=>loadUploads());
});
    </script>
</body>
</html>
